name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build plugin files
        run: |
          mkdir -p dist

          # --- Inline helper: merge SKILL.md + references into one file ---
          inline_refs() {
            local skill_dir="$1" out="$2"
            cp "$skill_dir/SKILL.md" "$out"
            if [ -d "$skill_dir/references" ]; then
              for ref in "$skill_dir"/references/*.md; do
                [ -f "$ref" ] || continue
                printf '\n\n---\n\n' >> "$out"
                cat "$ref" >> "$out"
              done
            fi
          }

          # --- Individual skill .zip files (single SKILL.md with refs inlined) ---
          for skill_dir in skills/russian-*/; do
            name=$(basename "$skill_dir")
            inline_refs "$skill_dir" "/tmp/${name}.md"
            tmpdir=$(mktemp -d)
            cp "/tmp/${name}.md" "$tmpdir/SKILL.md"
            (cd "$tmpdir" && zip "$OLDPWD/dist/${name}.zip" SKILL.md)
            rm -rf "$tmpdir" "/tmp/${name}.md"
          done

          # --- Full Cowork plugin (.plugin = zip with plugin.json + inlined skills) ---
          plugin_dir=$(mktemp -d)
          cp -r .claude-plugin "$plugin_dir/"
          cp -r commands "$plugin_dir/" 2>/dev/null || true
          cp LICENSE* README.md "$plugin_dir/" 2>/dev/null || true
          mkdir -p "$plugin_dir/skills"
          for skill_dir in skills/russian-*/; do
            name=$(basename "$skill_dir")
            mkdir -p "$plugin_dir/skills/$name"
            inline_refs "$skill_dir" "$plugin_dir/skills/$name/SKILL.md"
          done
          (cd "$plugin_dir" && zip -r "$OLDPWD/dist/claude-russian-editor.plugin" .)
          rm -rf "$plugin_dir"

          echo "## Built artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Установка / Installation

            ### Все навыки сразу / Full bundle (Cowork)

            Скачайте и откройте — плагин установится автоматически.
            Download and open — the plugin installs automatically.

            | Файл | Описание |
            |------|----------|
            | `claude-russian-editor.plugin` | Все 7 навыков + команда `/review` |

            ### Отдельные навыки / Individual skills

            Скачайте `.zip`, распакуйте и загрузите `SKILL.md` в Claude.
            Download the `.zip`, unpack, and upload `SKILL.md` to Claude.

            | Файл | Назначение |
            |----------|-----------|
            | `russian-names-capitalization.zip` | Имена, прописные, кавычки |
            | `russian-abbreviations.zip` | Сокращения и аббревиатуры |
            | `russian-numbers-dates.zip` | Числа, даты, знаки |
            | `russian-lists-punctuation.zip` | Перечни и пунктуация |
            | `russian-citations-bibliography.zip` | Цитаты, сноски, библиография |
            | `russian-typography-formatting.zip` | Тире, пробелы, выделения |
            | `russian-editorial-review.zip` | Мета-навык: полная проверка |
          files: |
            dist/claude-russian-editor.plugin
            dist/russian-abbreviations.zip
            dist/russian-citations-bibliography.zip
            dist/russian-editorial-review.zip
            dist/russian-lists-punctuation.zip
            dist/russian-names-capitalization.zip
            dist/russian-numbers-dates.zip
            dist/russian-typography-formatting.zip
