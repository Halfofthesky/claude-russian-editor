name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build plugin files
        run: |
          mkdir -p dist

          # Full bundle (.plugin = zip with plugin.json + all skills)
          zip -r dist/claude-russian-editor.plugin . \
            -x ".git/*" ".github/*" "dist/*" "install.sh" "*.DS_Store"

          # Individual skill .plugin files (each with its own plugin.json)
          for skill_dir in skills/russian-*/; do
            name=$(basename "$skill_dir")
            tmpdir=$(mktemp -d)

            # Create plugin structure
            mkdir -p "$tmpdir/.claude-plugin"
            mkdir -p "$tmpdir/skills/$name"

            # Generate plugin.json for this skill
            desc=$(head -5 "$skill_dir/SKILL.md" | grep "^description:" | sed 's/description: *//')
            cat > "$tmpdir/.claude-plugin/plugin.json" << PJSON
          {
            "name": "$name",
            "version": "${GITHUB_REF_NAME#v}",
            "description": "$desc",
            "author": { "name": "Stanislav" },
            "repository": "https://github.com/Halfofthesky/claude-russian-editor",
            "license": "CC-BY-NC-4.0"
          }
          PJSON

            # Copy skill file
            cp "$skill_dir/SKILL.md" "$tmpdir/skills/$name/"

            # Package as .plugin
            (cd "$tmpdir" && zip -r "$OLDPWD/dist/${name}.plugin" .)
            rm -rf "$tmpdir"
          done

          echo "## Built artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Установка / Installation

            ### Все навыки сразу / Full bundle

            Скачайте и откройте — плагин установится автоматически.
            Download and open — the plugin installs automatically.

            | Файл | Описание |
            |------|----------|
            | `claude-russian-editor.plugin` | Все 7 навыков + команда `/review` |

            Или одной командой для Claude Code:
            ```bash
            curl -sL https://raw.githubusercontent.com/Halfofthesky/claude-russian-editor/main/install.sh | bash
            ```

            ### Отдельные навыки / Individual skills

            Скачайте и откройте нужный `.plugin` файл.
            Download and open the `.plugin` file you need.

            | Файл | Назначение |
            |-------|-----------|
            | `russian-names-capitalization.plugin` | Имена, прописные, кавычки |
            | `russian-abbreviations.plugin` | Сокращения и аббревиатуры |
            | `russian-numbers-dates.plugin` | Числа, даты, знаки |
            | `russian-lists-punctuation.plugin` | Перечни и пунктуация |
            | `russian-citations-bibliography.plugin` | Цитаты, сноски, библиография |
            | `russian-typography-formatting.plugin` | Тире, пробелы, выделения |
            | `russian-editorial-review.plugin` | Мета-навык: полная проверка |
          files: |
            dist/claude-russian-editor.plugin
            dist/russian-abbreviations.plugin
            dist/russian-citations-bibliography.plugin
            dist/russian-editorial-review.plugin
            dist/russian-lists-punctuation.plugin
            dist/russian-names-capitalization.plugin
            dist/russian-numbers-dates.plugin
            dist/russian-typography-formatting.plugin
